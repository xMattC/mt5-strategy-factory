#include <MyLibs/NNFX_TestFileHeader.mqh>
{% for include in includes %}
#include <{{ include }}>
{% endfor %}

{% for enum in enum_definitions %}
{{ enum }}
{% endfor %}
{% for line in input_lines %}
{{ line }}
{% endfor %}

int indicator_trigger_handle[];        // Handles for trigger indicators
int indicator_conformation_handle[];   // Handles for conformation indicators

int OnInit(){
    EventSetTimer(60);
    mf.get_white_list(inp_sym_mode, SymbolsArray);

    ArrayResize(indicator_trigger_handle, ArraySize(SymbolsArray));
    ArrayResize(indicator_conformation_handle, ArraySize(SymbolsArray));

    for(int i = 0; i < ArraySize(SymbolsArray); i++){
        indicator_trigger_handle[i] = iCustom(SymbolsArray[i], PERIOD_CURRENT, "{{ trigger_path }}"{% for val in trigger_inputs %}, {{ val }}{% endfor %});
        indicator_conformation_handle[i] = iCustom(SymbolsArray[i], PERIOD_CURRENT, "{{ confirmation_path }}"{% for val in confirmation_inputs %}, {{ val }}{% endfor %});
    }
    return(INIT_SUCCEEDED);
}

void OnDeinit(const int reason){}

void OnTimer(){
    if(!mf.in_test_period(inp_data_split_method)){return;}
    if(!mf.is_new_bar(_Symbol, PERIOD_CURRENT, "00:05")){return;}
    for(int i = 0; i < ArraySize(SymbolsArray); i++){
        stratagy(SymbolsArray[i], indicator_trigger_handle[i], indicator_conformation_handle[i]);
    }
}

double OnTester(){
    return cm.calculate_custom_criteria(inp_custom_criteria);
}

// Main logic function
void stratagy(string symbol, int trigger_handle, int conformation_handle){
    bool trigger_long, trigger_short;
    bool conf_long, conf_short;

    trigger(trigger_handle, trigger_long, trigger_short);
    conformation(conformation_handle, conf_long, conf_short);

    bool long_in = (trigger_long && conf_long);
    bool short_in = (trigger_short && conf_short);
    bool long_out = 0;
    bool short_out = 0;

    //--- Manage orders
    om.close_buy_orders(symbol, long_out, 0, PERIOD_CURRENT, 42);
    om.close_sell_orders(symbol, short_out, 0, PERIOD_CURRENT, 42);
    om.open_buy_orders(symbol, long_in, PERIOD_CURRENT, sl_mode, inp_sl_var, tp_mode, inp_tp_var, lot_mode, inp_lot_var, 42);
    om.open_sell_orders(symbol, short_in, PERIOD_CURRENT, sl_mode, inp_sl_var, tp_mode, inp_tp_var, lot_mode, inp_lot_var, 42);
}

// Trigger logic (from IS-optimised trigger YAML/result)
void trigger(int indi_handle, bool &trigger_long, bool &trigger_short){
    {% for buf in trigger_buffers %}
    double {{ buf.name }}[];
    ArraySetAsSeries({{ buf.name }}, true);
    CopyBuffer(indi_handle, {{ buf.index }}, 1, 10, {{ buf.name }});
    {% endfor %}
    trigger_long = ({{ trigger_long_expr }});
    trigger_short = ({{ trigger_short_expr }});
}

// Conformation logic (from indicator YAML)
void conformation(int indi_handle, bool &conf_long, bool &conf_short){
    {% for buf in confirmation_buffers %}
    double {{ buf.name }}[];
    ArraySetAsSeries({{ buf.name }}, true);
    CopyBuffer(indi_handle, {{ buf.index }}, 1, 10, {{ buf.name }});
    {% endfor %}
    conf_long = ({{ conf_long_expr }});
    conf_short = ({{ conf_short_expr }});
}
